rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isValidString(value, minLen, maxLen) {
      return value is string 
        && value.size() >= minLen 
        && value.size() <= maxLen;
    }
    
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    function hasValidTimestamp(data) {
      return data.keys().hasAll(['createdAt', 'updatedAt'])
        && data.createdAt is timestamp
        && data.updatedAt is timestamp;
    }
    
    function isNotModifying(field) {
      return !(field in request.resource.data) 
        || request.resource.data[field] == resource.data[field];
    }
    
    function isValidNumber(value, min, max) {
      return value is number 
        && value >= min 
        && value <= max;
    }
    
    // ========================================
    // USERS COLLECTION
    // ========================================
    
    match /users/{userId} {
      allow read: if isOwner(userId);
      
      allow create: if isOwner(userId)
        && hasValidTimestamp(request.resource.data);
      
      allow update: if isOwner(userId)
        && hasValidTimestamp(request.resource.data)
        && isNotModifying('createdAt')
        && isNotModifying('uid');
      
      allow delete: if isOwner(userId);
      
      // User settings subcollection
      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
      }
      
      // Web Leads subcollection
      match /webLeads/{ico} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // ========================================
    // GLOBAL COMPANIES CACHE
    // ========================================
    
    match /companies/{ico} {
      // Authenticated users can search/read existing cache
      allow read: if isSignedIn();
      // ONLY Backend (Admin SDK) can write/update canonical data
      allow write: if false; 
    }
    
    // ========================================
    // INVOICES COLLECTION
    // ========================================
    
    match /users/{userId}/invoices/{invoiceId} {
      allow read: if isOwner(userId);
      
      allow create: if isOwner(userId)
        && hasValidTimestamp(request.resource.data)
        && isValidString(request.resource.data.invoiceNumber, 1, 50)
        && request.resource.data.amount is number
        && request.resource.data.amount > 0
        && request.resource.data.currency is string
        && request.resource.data.status in ['draft', 'sent', 'paid', 'cancelled'];
      
      allow update: if isOwner(userId)
        && hasValidTimestamp(request.resource.data)
        && isNotModifying('createdAt')
        && isNotModifying('invoiceNumber');
      
      allow delete: if isOwner(userId);
    }
    
    // Legacy invoices path
    match /invoices/{userId}/{document=**} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    // ========================================
    // EXPENSES COLLECTION
    // ========================================
    
    match /users/{userId}/expenses/{expenseId} {
      allow read: if isOwner(userId);
      
      allow create: if isOwner(userId)
        && hasValidTimestamp(request.resource.data)
        && request.resource.data.amount is number
        && request.resource.data.amount > 0
        && request.resource.data.currency is string
        && request.resource.data.category is string;
      
      allow update: if isOwner(userId)
        && hasValidTimestamp(request.resource.data)
        && isNotModifying('createdAt');
      
      allow delete: if isOwner(userId);
    }
    
    // Legacy expenses path
    match /expenses/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }
    
    // ========================================
    // RECEIPTS COLLECTION
    // ========================================
    
    match /receipts/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }
    
    // ========================================
    // SOFT DELETED ITEMS
    // ========================================
    
    match /soft_deleted_invoices/{userId}/items/{itemId} {
      allow read, write: if isOwner(userId);
    }

    match /soft_deleted_bizbot_conversations/{userId}/items/{itemId} {
      allow read, write: if isOwner(userId);
    }

    match /soft_deleted_notepad_items/{userId}/items/{itemId} {
      allow read, write: if isOwner(userId);
    }
    
    // ========================================
    // INVOICE NUMBERING
    // ========================================
    
    match /invoice_numbering/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }
    
    // ========================================
    // ANALYTICS EVENTS (Write-only)
    // ========================================
    
    match /analytics/{eventId} {
      allow create: if isSignedIn()
        && request.resource.data.timestamp is timestamp
        && request.resource.data.userId is string
        && request.resource.data.eventType is string;
      
      allow read, update, delete: if false;
    }
    
    // ========================================
    // FEEDBACK COLLECTION
    // ========================================
    
    match /feedback/{feedbackId} {
      allow create: if isSignedIn()
        && hasValidTimestamp(request.resource.data)
        && request.resource.data.rating is number
        && request.resource.data.rating >= 1
        && request.resource.data.rating <= 5;
      
      allow read: if isSignedIn() 
        && resource.data.userId == request.auth.uid;
      
      allow update, delete: if false;
    }
    
    // ========================================
    // BACKUP METADATA
    // ========================================
    
    match /users/{userId}/backups/{backupId} {
      allow read, write: if isOwner(userId)
        && hasValidTimestamp(request.resource.data);
    }
    
    // ========================================
    // DEFAULT DENY ALL
    // ========================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
